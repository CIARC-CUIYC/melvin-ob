name: "Build and Deploy"
on: [push]
jobs:
  build-deploy:
    name: "Build on pi01 and Deploy"
    runs-on: pi01
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          rustflags: "-C target-feature=+crt-static"
          target: x86_64-unknown-linux-gnu
      - name: Build
        run: cargo build --release --target x86_64-unknown-linux-gnu --config target.x86_64-unknown-linux-gnu.linker=\"x86_64-linux-gnu-gcc\"

      - name: Deploy
        if: ${{ (github.ref == 'refs/heads/main' && !contains(github.event.head_commit.message, '[no-deploy]')) || contains(github.event.head_commit.message, '[force-deploy]') }}
        run: |
          sshpass -p password ssh root@10.100.10.3 'tmux kill-session -t melvin-runner || true'
          sshpass -p password scp target/x86_64-unknown-linux-gnu/release/melvin-ob root@10.100.10.3:/home/melvin-ob
  build-docker:
    name: "Build docker on arche"
    if: ${{ github.ref == 'refs/heads/main' || contains(github.event.head_commit.message, '[force-container]') }}
    runs-on: arche
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Docker build
        run: docker build . --tag melvin-ob:latest
